---
status: pending
---

# 015: Implement Backfill and Catchup Support

## Summary
Add backfill capabilities that allow operators to trigger DAG runs for historical date ranges, with configurable parallelism and date macro support (`{{ ds }}`, `{{ execution_date }}`).

## Motivation
Airflow's backfill is essential for reprocessing historical data — when a pipeline is fixed or new logic added, operators need to re-run it for past dates. The scheduler (008) added basic `catchup` support; this commit provides a full-featured backfill system with date macros, parallel historical runs, and dry-run preview.

## Changes

### Files to Create
- `packages/pipeline-core/src/scheduler/backfill.ts` — `BackfillService`:
  - `backfill(options: BackfillOptions)` → execute DAG runs for date range:
    - `dagId` — which DAG to backfill
    - `startDate` / `endDate` — date range
    - `maxParallelRuns` — how many historical runs to execute simultaneously (default 1)
    - `dryRun` — preview which dates would be created (no execution)
    - `rerunFailed` — only re-run dates that previously failed
    - `resetDagRun` — clear existing run before re-running
    - `conf` — optional config passed to each run
  - Generates execution dates based on DAG's schedule interval
  - Creates DAGRuns and dispatches to executor (sequentially or parallel)
  - Progress tracking: total, completed, failed, remaining
- `packages/pipeline-core/src/scheduler/date-macros.ts` — Date template variables:
  - `{{ ds }}` → execution date as YYYY-MM-DD
  - `{{ ds_nodash }}` → YYYYMMDD
  - `{{ execution_date }}` → ISO 8601 timestamp
  - `{{ prev_ds }}` → previous schedule date
  - `{{ next_ds }}` → next schedule date
  - `{{ dag_run.conf.<key> }}` → run configuration parameter
  - `resolveDateMacros(template, executionDate, schedule)` → resolved string
- `packages/pipeline-core/src/scheduler/backfill-types.ts` — Types:
  - `BackfillOptions`: dagId, startDate, endDate, maxParallelRuns, dryRun, rerunFailed, resetDagRun, conf
  - `BackfillResult`: totalDates, completed, failed, skipped, results[]
  - `BackfillPreview`: dates[], existingRuns[], newRuns[]

### Files to Modify
- `packages/pipeline-core/src/dag/executor.ts` — Accept `executionDate` parameter, resolve date macros in templates before execution
- `packages/pipeline-core/src/dag/xcom/xcom-template-resolver.ts` — Add date macro resolution
- `packages/pipeline-core/src/scheduler/scheduler.ts` — Use date macros when creating scheduled runs
- `packages/pipeline-core/src/scheduler/index.ts` — Re-export backfill module

## Implementation Notes
- Execution dates are generated by iterating from `startDate` to `endDate` using the DAG's cron schedule interval
- `maxParallelRuns=1` is the safe default — prevents data pipeline race conditions
- `dryRun` returns a preview without executing — useful for verifying the date range
- `rerunFailed` queries the run store for failed runs in the date range — only those get re-executed
- `resetDagRun` clears existing run state (task instances, XCom) before re-running — prevents stale data
- Date macros are resolved AFTER XCom templates — order matters (XCom might not exist during backfill)
- Each backfill run gets its own `executionDate` that replaces macros — enables date-partitioned processing

## Tests
- `packages/pipeline-core/test/scheduler/backfill.test.ts`:
  - Backfill daily DAG for 7-day range → 7 runs created
  - `maxParallelRuns=3` → max 3 concurrent runs
  - `dryRun` returns dates without executing
  - `rerunFailed` only re-runs failed dates
  - `resetDagRun` clears previous state before re-run
  - Hourly schedule generates correct number of runs
  - Empty date range → no runs
- `packages/pipeline-core/test/scheduler/date-macros.test.ts`:
  - `{{ ds }}` resolves to correct format
  - `{{ prev_ds }}` / `{{ next_ds }}` offset correctly by schedule
  - `{{ dag_run.conf.param }}` resolves from run config
  - Unknown macros left unchanged
  - Multiple macros in one template all resolved

## Acceptance Criteria
- [ ] Backfill creates correct number of runs for date range + schedule
- [ ] Date macros resolve correctly in task templates
- [ ] `dryRun` previews without executing
- [ ] `rerunFailed` only re-runs failed dates
- [ ] Parallel backfill respects `maxParallelRuns` limit
- [ ] Existing scheduled execution still works
- [ ] Existing tests pass

## Dependencies
- Depends on: 008, 004, 007
